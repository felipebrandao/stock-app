<div class="bg-background-light dark:bg-background-dark text-[#111813] dark:text-gray-100 min-h-screen flex flex-col">
  <main class="flex-1 flex justify-center py-5 px-4 md:px-6 lg:px-10">
    <div class="w-full max-w-[1200px] flex flex-col">

      <div class="flex flex-wrap gap-2 px-4 pb-2">
        <a class="text-[#61896f] hover:text-[#111813] dark:hover:text-white transition-colors text-xs font-medium leading-normal cursor-pointer" routerLink="/nfce-history">NFC-e</a>
        <span class="text-[#61896f] text-xs font-medium leading-normal">/</span>
        <span class="text-[#111813] dark:text-white text-xs font-medium leading-normal">Revisão Inteligente</span>
      </div>

      <div *ngIf="loading" class="flex flex-col items-center justify-center py-20 gap-4">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary"></div>
        <p class="text-sm text-[#61896f]">Carregando detalhes da NFC-e...</p>
      </div>

      <div *ngIf="error && !loading" class="flex flex-col items-center justify-center py-20 gap-4">
        <span class="material-symbols-outlined text-red-500 text-6xl">error</span>
        <p class="text-sm text-red-500 dark:text-red-400">{{ error }}</p>
        <button
          (click)="loadNfceDetails()"
          class="px-4 py-2 bg-primary text-[#111813] rounded-lg text-sm font-bold hover:bg-[#0fd650] transition-colors"
        >
          Tentar novamente
        </button>
      </div>

      <div *ngIf="!loading && !error && reviewData" class="flex flex-col">

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 p-4 mb-4">
          <div>
            <h1 class="text-[#111813] dark:text-white text-2xl font-black leading-tight tracking-[-0.033em]">Revisão de Importação NFC-e</h1>
            <p class="text-sm text-[#61896f] mt-1">O sistema mapeou automaticamente itens conhecidos. Revise apenas as novidades.</p>
          </div>
          <div class="flex flex-wrap gap-3">
            <button
              (click)="goBack()"
              class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-white dark:bg-[#1c2920] border border-[#dbe6df] dark:border-[#2a382e] hover:bg-[#f0f4f2] text-[#111813] dark:text-white text-sm font-bold transition-colors"
            >
              <span class="material-symbols-outlined text-lg">history</span>
              <span>Histórico</span>
            </button>
            <button
              (click)="approveImport()"
              [disabled]="loading || getPendingCount() > 0"
              class="flex items-center justify-center gap-2 rounded-lg h-10 px-6 bg-primary hover:bg-[#0fd650] text-[#102216] text-sm font-black transition-all shadow-[0px_4px_12px_rgba(19,236,91,0.25)] disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="material-symbols-outlined text-lg">magic_button</span>
              <span>Confirmação Inteligente</span>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 px-4 mb-6">
          <div class="flex flex-col p-4 bg-white dark:bg-[#1c2920] border border-[#dbe6df] dark:border-[#2a382e] rounded-xl">
            <span class="text-[#61896f] text-xs font-bold uppercase tracking-wider">Itens Mapeados</span>
            <div class="flex items-end gap-2 mt-1">
              <span class="text-3xl font-black text-primary">{{ getMappedCount() }}</span>
              <span class="text-[#61896f] text-sm mb-1">automação aplicada</span>
            </div>
          </div>
          <div class="flex flex-col p-4 bg-white dark:bg-[#1c2920] border border-[#dbe6df] dark:border-[#2a382e] rounded-xl">
            <span class="text-[#61896f] text-xs font-bold uppercase tracking-wider">Novos Itens</span>
            <div class="flex items-end gap-2 mt-1">
              <span class="text-3xl font-black text-blue-500">{{ getPendingCount() }}</span>
              <span class="text-[#61896f] text-sm mb-1">requer atenção</span>
            </div>
          </div>
          <div class="flex flex-col p-4 bg-white dark:bg-[#1c2920] border border-[#dbe6df] dark:border-[#2a382e] rounded-xl">
            <span class="text-[#61896f] text-xs font-bold uppercase tracking-wider">Valor Total</span>
            <div class="flex items-end gap-2 mt-1">
              <span class="text-3xl font-black text-[#111813] dark:text-white">{{ formatCurrency(getTotalValue()) }}</span>
              <span class="text-[#61896f] text-sm mb-1">NFC-e</span>
            </div>
          </div>
        </div>

        <div class="px-4">
          <div class="flex flex-col overflow-hidden rounded-xl border border-[#dbe6df] dark:border-[#2a382e] bg-white dark:bg-[#1c2920]">
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="bg-[#f6f8f6] dark:bg-[#152018] border-b border-[#dbe6df] dark:border-[#2a382e]">
                    <th class="px-6 py-4 text-left text-[#111813] dark:text-white text-xs font-bold uppercase tracking-wider">Descrição NFC-e / Mapeamento</th>
                    <th class="px-6 py-4 text-center text-[#111813] dark:text-white text-xs font-bold uppercase tracking-wider">Qtd</th>
                    <th class="px-6 py-4 text-right text-[#111813] dark:text-white text-xs font-bold uppercase tracking-wider">Unitário</th>
                    <th class="px-6 py-4 text-right text-[#111813] dark:text-white text-xs font-bold uppercase tracking-wider">Total</th>
                    <th class="px-6 py-4 text-center text-[#111813] dark:text-white text-xs font-bold uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-right text-[#111813] dark:text-white text-xs font-bold uppercase tracking-wider">Ações</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-[#dbe6df] dark:divide-[#2a382e]">
                  <tr
                    *ngFor="let item of items"
                    [ngClass]="{
                      'bg-white dark:bg-[#1c2920] opacity-80': item.status === 'MAPPED',
                      'bg-blue-50/50 dark:bg-blue-900/10 border-l-4 border-l-blue-500': item.status !== 'MAPPED'
                    }"
                    class="hover:bg-[#f6f8f6] dark:hover:bg-[#233127] transition-colors"
                  >
                    <td class="px-6 py-4">
                      <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                          <span
                            class="text-sm uppercase"
                            [ngClass]="{
                              'font-bold text-[#111813] dark:text-white': item.status === 'MAPPED',
                              'font-black text-[#111813] dark:text-white': item.status !== 'MAPPED'
                            }"
                          >
                            {{ item.description }}
                          </span>
                          <span
                            *ngIf="item.status === 'MAPPED'"
                            class="px-1.5 py-0.5 rounded text-[9px] font-black bg-primary/20 text-primary uppercase tracking-tighter border border-primary/30"
                          >
                            Já conhecido
                          </span>
                        </div>
                        <span
                          *ngIf="item.status === 'MAPPED' && item.productId"
                          class="text-[10px] text-[#61896f] font-mono"
                        >
                          ➡ Vinculado a: Produto {{ item.productId }}
                        </span>
                        <span
                          *ngIf="item.status !== 'MAPPED'"
                          class="text-[10px] text-blue-600 dark:text-blue-400 font-bold"
                        >
                          Item não encontrado no catálogo histórico
                        </span>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span
                        class="text-sm"
                        [ngClass]="{
                          'font-medium': item.status === 'MAPPED',
                          'font-black text-blue-700 dark:text-blue-300': item.status !== 'MAPPED'
                        }"
                      >
                        {{ item.quantity }} {{ item.unit }}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <span
                        class="text-sm"
                        [ngClass]="{
                          'text-[#61896f] font-medium': item.status === 'MAPPED',
                          'text-[#111813] dark:text-white font-black': item.status !== 'MAPPED'
                        }"
                      >
                        {{ formatCurrency(item.unitPrice) }}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <span
                        class="text-sm"
                        [ngClass]="{
                          'text-[#61896f] font-bold': item.status === 'MAPPED',
                          'text-[#111813] dark:text-white font-black': item.status !== 'MAPPED'
                        }"
                      >
                        {{ formatCurrency(item.totalPrice) }}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span
                        *ngIf="item.status === 'MAPPED'"
                        class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-[#13ec5b]/10 text-[#0c9d3d]"
                      >
                        Mapeado
                      </span>
                      <span
                        *ngIf="item.status !== 'MAPPED'"
                        class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-black bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700 uppercase"
                      >
                        <span class="size-1.5 rounded-full bg-blue-500"></span>
                        Novo
                      </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <button
                        *ngIf="item.status === 'MAPPED'"
                        (click)="editItem(item.id)"
                        class="text-[#61896f] hover:text-[#111813] dark:hover:text-white text-xs font-bold uppercase transition-colors"
                      >
                        Ajustar
                      </button>
                      <button
                        *ngIf="item.status !== 'MAPPED'"
                        (click)="editItem(item.id)"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-xs font-black uppercase shadow-sm transition-all"
                      >
                        Mapear
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="flex flex-col-reverse sm:flex-row justify-between items-center gap-4 p-4 mt-8 bg-white dark:bg-[#111813] border border-[#dbe6df] dark:border-[#2a382e] rounded-xl mx-4">
          <div class="flex flex-col sm:flex-row items-center gap-4">
            <div *ngIf="getPendingCount() > 0" class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <span class="material-symbols-outlined text-blue-500 text-lg">info</span>
              <span class="text-sm font-medium text-blue-800 dark:text-blue-300">
                Você possui {{ getPendingCount() }} {{ getPendingCount() === 1 ? 'item novo que requer' : 'itens novos que requerem' }} mapeamento manual.
              </span>
            </div>
            <div *ngIf="getPendingCount() === 0" class="flex items-center gap-2 px-3 py-1.5 bg-green-50 dark:bg-green-900/20 rounded-lg">
              <span class="material-symbols-outlined text-green-500 text-lg">check_circle</span>
              <span class="text-sm font-medium text-green-800 dark:text-green-300">
                Todos os itens foram mapeados! Você pode finalizar a entrada.
              </span>
            </div>
          </div>
          <div class="flex gap-4 w-full sm:w-auto">
            <button
              (click)="approveImport()"
              [disabled]="loading || getPendingCount() > 0"
              class="flex-1 sm:flex-none flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-10 bg-primary hover:bg-[#0fd650] text-[#102216] text-base font-black leading-normal tracking-[0.015em] shadow-[0px_4px_12px_rgba(19,236,91,0.25)] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span class="material-symbols-outlined mr-2">publish</span>
              Finalizar Entrada ({{ items.length }} {{ items.length === 1 ? 'Item' : 'Itens' }})
            </button>
          </div>
        </div>

      </div>
    </div>
  </main>
</div>

<app-manage-nfce-item-modal
  [isOpen]="isModalOpen"
  [item]="selectedItem"
  (close)="closeModal()"
  (confirm)="onModalConfirm($event)"
></app-manage-nfce-item-modal>
